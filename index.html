<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatatUang v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #0f172a; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .card-neo { background: #ffffff; border: 1px solid #f1f5f9; box-shadow: 0 4px 20px -2px rgba(0,0,0,0.03); border-radius: 28px; }
        .nav-active { color: #0d9488; background: #f0fdfa; }
        input, select { border: 1px solid #e2e8f0; outline: none; transition: all 0.2s; padding: 12px 16px; border-radius: 16px; width: 100%; font-size: 14px; }
        input:focus, select:focus { border-color: #0d9488; box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.08); }
        #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen pb-28">

    <!-- Screen Loading -->
    <div id="loader">
        <div class="flex flex-col items-center p-6 text-center max-w-xs w-full">
            <div class="bg-teal-600 p-4 rounded-3xl text-white mb-6 animate-bounce shadow-xl shadow-teal-200">
                <i data-lucide="wallet-cards" class="w-8 h-8"></i>
            </div>
            <h2 class="font-black text-slate-800 mb-1">Shared Cloud</h2>
            <p id="loader-text" class="text-xs text-slate-400 mb-6 font-medium">Menghubungkan ke database bersama...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 bg-white/80 backdrop-blur-md z-40 border-b border-slate-100 p-4">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-teal-600 p-2 rounded-xl text-white shadow-lg"><i data-lucide="gem" class="w-5 h-5"></i></div>
                <h1 class="text-lg font-extrabold tracking-tight">Catat<span class="text-teal-600">Uang (v2)</span></h1>
            </div>
            <div id="badge-status" class="flex items-center gap-2 px-3 py-1 bg-green-50 rounded-full border border-green-100">
                <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-[9px] font-black text-green-600 uppercase tracking-widest">Status Online</span>
            </div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto p-4 space-y-6">
        <!-- TAB: RINGKASAN -->
        <section id="tab-home" class="tab-content active space-y-6">
            <div class="space-y-4">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2 text-center">LAPORAN PENGELUARAN</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card-neo p-6 bg-teal-600 text-white shadow-lg shadow-teal-100">
                        <p class="text-[10px] font-bold opacity-80 uppercase mb-1">Bulan Ini</p>
                        <h4 class="text-2xl font-black mb-1" id="sum-exp-month-val">Rp 0</h4>
                        <p class="text-[10px] font-bold opacity-70" id="sum-exp-month-count">0 Transaksi</p>
                    </div>
                    <div class="card-neo p-6 bg-slate-900 text-white">
                        <p class="text-[10px] font-bold opacity-60 uppercase mb-1">Tahun Ini</p>
                        <h4 class="text-2xl font-black mb-1" id="sum-exp-year-val">Rp 0</h4>
                        <p class="text-[10px] font-bold opacity-60" id="sum-exp-year-count">0 Transaksi</p>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2 text-center">Laporan Pinjaman</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card-neo p-6 border-indigo-100 bg-white">
                        <p class="text-[10px] font-bold text-indigo-600 uppercase mb-1">Piutang Bulan Ini</p>
                        <h4 class="text-2xl font-black text-slate-900 mb-1" id="sum-debt-month-val">Rp 0</h4>
                        <p class="text-[10px] font-bold text-slate-400" id="sum-debt-month-count">0 Item</p>
                    </div>
                    <div class="card-neo p-6 border-slate-100 bg-white">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1 text-teal-600">Total Piutang Aktif</p>
                        <h4 class="text-2xl font-black text-slate-900 mb-1" id="sum-debt-total-val">Rp 0</h4>
                        <p class="text-[10px] font-bold text-slate-400" id="sum-debt-total-count">0 Item Aktif</p>
                    </div>
                </div>
            </div>

            <div class="space-y-4 pt-2">
                <h3 class="text-sm font-bold px-2 text-slate-800">Aktivitas Terakhir</h3>
                <div id="home-activity-list" class="space-y-3"></div>
            </div>
        </section>

        <!-- TAB: PENGELUARAN -->
        <section id="tab-expenses" class="tab-content space-y-6">
            <div class="card-neo p-6 border-teal-100">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-[10px] font-bold text-teal-600 uppercase mb-1 tracking-widest">Filter Laporan</p>
                        <h4 class="text-2xl font-black text-slate-900" id="exp-filter-total">Rp 0</h4>
                        <p class="text-xs font-bold text-slate-400 mt-1" id="exp-filter-count">0 Transaksi</p>
                    </div>
                    <div class="flex flex-col gap-2">
                        <select id="exp-filter-month" onchange="refreshUI()" class="text-[10px] font-bold bg-slate-50 border-none"></select>
                        <select id="exp-filter-year" onchange="refreshUI()" class="text-[10px] font-bold bg-slate-50 border-none"></select>
                    </div>
                </div>
                <button onclick="toggleForm('form-expense')" class="w-full flex items-center justify-center gap-2 py-4 bg-teal-600 text-white rounded-2xl font-black shadow-lg uppercase tracking-wider">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Tambah Pengeluaran
                </button>
            </div>

            <div id="form-expense" class="hidden card-neo p-6 border-teal-200 bg-teal-50/30">
                <form id="expense-form" class="space-y-4">
                    <input type="text" id="exp-desc" placeholder="Keterangan..." class="bg-white shadow-sm" required>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="exp-amount" placeholder="Nominal" class="bg-white shadow-sm font-black" required>
                        <select id="exp-category" class="bg-white shadow-sm font-bold text-teal-600"></select>
                    </div>
                    <input type="date" id="exp-date" class="bg-white shadow-sm font-bold text-slate-500" required>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-teal-600 text-white py-4 rounded-2xl font-black">SIMPAN</button>
                        <button type="button" onclick="toggleForm('form-expense')" class="px-6 bg-white border border-slate-200 rounded-2xl font-bold text-slate-400">BATAL</button>
                    </div>
                </form>
            </div>
            <div id="expense-list-full" class="space-y-3"></div>
        </section>

        <!-- TAB: PIUTANG -->
        <section id="tab-piutang" class="tab-content space-y-6">
            <div class="card-neo p-6 border-indigo-100">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-[10px] font-bold text-indigo-600 uppercase mb-1 tracking-widest">Pinjaman Orang</p>
                        <h4 class="text-2xl font-black text-slate-900" id="debt-filter-total">Rp 0</h4>
                        <p class="text-xs font-bold text-slate-400 mt-1" id="debt-filter-count">0 Item</p>
                    </div>
                    <div class="flex flex-col gap-2">
                        <select id="debt-filter-month" onchange="refreshUI()" class="text-[10px] font-bold bg-slate-50 border-none"></select>
                        <select id="debt-filter-year" onchange="refreshUI()" class="text-[10px] font-bold bg-slate-50 border-none"></select>
                    </div>
                </div>
                <button onclick="toggleForm('form-debt')" class="w-full flex items-center justify-center gap-2 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg uppercase tracking-wider">
                    <i data-lucide="hand-coins" class="w-5 h-5"></i> Catat Piutang Baru
                </button>
            </div>

            <div id="form-debt" class="hidden card-neo p-6 border-indigo-200 bg-indigo-50/30">
                <form id="debt-form" class="space-y-4">
                    <input type="text" id="debt-name" placeholder="Nama Peminjam..." class="bg-white shadow-sm font-medium" required>
                    <input type="number" id="debt-amount" placeholder="Nominal Rp" class="bg-white shadow-sm font-black" required>
                    <input type="date" id="debt-date" class="bg-white shadow-sm font-bold text-slate-500" required>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-black">CATAT</button>
                        <button type="button" onclick="toggleForm('form-debt')" class="px-6 bg-white border border-slate-200 rounded-2xl font-bold text-slate-400">BATAL</button>
                    </div>
                </form>
            </div>
            <div id="debt-list-full" class="space-y-3"></div>
        </section>

        <!-- TAB: PENGATURAN -->
        <section id="tab-settings" class="tab-content space-y-6">
            <h2 class="text-xl font-black px-2">Pengaturan Cloud Bersama</h2>
            <div class="card-neo p-6 space-y-6">
                <div class="space-y-3">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-1">Manajemen Data</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="document.getElementById('file-import').click()" class="flex flex-col items-center gap-3 p-6 bg-teal-50 rounded-[2rem] text-teal-600 border border-teal-100 hover:bg-teal-100 transition shadow-sm">
                            <i data-lucide="upload-cloud"></i> <span class="text-[10px] font-black uppercase">Impor JSON</span>
                            <input type="file" id="file-import" class="hidden" accept=".json">
                        </button>
                        <button onclick="exportData()" class="flex flex-col items-center gap-3 p-6 bg-indigo-50 rounded-[2rem] text-indigo-600 border border-indigo-100 hover:bg-indigo-100 transition shadow-sm">
                            <i data-lucide="download"></i> <span class="text-[10px] font-black uppercase">Ekspor JSON</span>
                        </button>
                    </div>
                    <p class="text-[9px] text-slate-400 italic text-center px-4 leading-relaxed">
                        Data yang Anda impor akan otomatis muncul di HP/Laptop lain yang menggunakan Firebase yang sama.
                    </p>
                </div>
                <div class="space-y-3">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-1">Kelola Kategori</p>
                    <form id="cat-form" class="flex gap-2">
                        <input type="text" id="cat-new-name" placeholder="Kategori baru..." class="flex-1 text-sm font-bold bg-slate-50 border-none">
                        <button type="submit" class="bg-teal-600 text-white px-5 rounded-2xl font-bold"><i data-lucide="plus"></i></button>
                    </form>
                    <div id="cat-manager-list" class="grid grid-cols-2 gap-2 mt-2"></div>
                </div>
                <div class="pt-6 border-t border-slate-100">
                    <button onclick="clearAllDataCloud()" class="w-full py-4 text-rose-500 font-bold border-2 border-rose-50 rounded-2xl text-sm hover:bg-rose-50 transition active:scale-[0.98]">RESET DATA CLOUD</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t border-slate-100 p-4 z-40 shadow-[0_-4px_30px_rgba(0,0,0,0.05)]">
        <div class="max-w-2xl mx-auto flex justify-between gap-2">
            <button onclick="switchTab('tab-home')" class="nav-btn flex-1 flex flex-col items-center gap-1.5 py-3 rounded-2xl nav-active" id="btn-tab-home"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="text-[9px] font-black uppercase">Home</span></button>
            <button onclick="switchTab('tab-expenses')" class="nav-btn flex-1 flex flex-col items-center gap-1.5 py-3 rounded-2xl text-slate-400" id="btn-tab-expenses"><i data-lucide="receipt" class="w-5 h-5"></i><span class="text-[9px] font-black uppercase">Expenses</span></button>
            <button onclick="switchTab('tab-piutang')" class="nav-btn flex-1 flex flex-col items-center gap-1.5 py-3 rounded-2xl text-slate-400" id="btn-tab-piutang"><i data-lucide="hand-coins" class="w-5 h-5"></i><span class="text-[9px] font-black uppercase">Debts</span></button>
            <button onclick="switchTab('tab-settings')" class="nav-btn flex-1 flex flex-col items-center gap-1.5 py-3 rounded-2xl text-slate-400" id="btn-tab-settings"><i data-lucide="settings-2" class="w-5 h-5"></i><span class="text-[9px] font-black uppercase">Settings</span></button>
        </div>
    </nav>

    <!-- Toast -->
    <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full text-xs font-bold hidden z-[100] shadow-2xl items-center gap-3">
        <i data-lucide="check-circle" class="w-4 h-4 text-teal-400"></i>
        <span id="toast-msg">Berhasil</span>
    </div>

    <!-- Firebase Implementation (Shared Mode) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, collection, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCsQrVXOV-FrsYmHg2C5GIDBS3egLBS1hA",
            authDomain: "catatankeuangan-cc615.firebaseapp.com",
            projectId: "catatankeuangan-cc615",
            storageBucket: "catatankeuangan-cc615.firebasestorage.app",
            messagingSenderId: "363688782200",
            appId: "1:363688782200:web:d6e3df790557fe99a9c08d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appIdStr = 'catatankeuangan-cc615';

        window.state = { expenses: [], debts: [], categories: ["Makan", "Transport", "Mobil", "Motor", "Lainnya"], user: null };

        // SHARED PATH (RULE 1)
        // Folder: artifacts/catatankeuangan-cc615/public/data/expenses
        const getCol = (name) => collection(db, 'artifacts', appIdStr, 'public', 'data', name);
        const getDocRef = (name, id) => doc(db, 'artifacts', appIdStr, 'public', 'data', name, id);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.state.user = user;
                startSync();
            }
        });

        (async () => {
            try { await signInAnonymously(auth); } catch(e) { console.error(e); }
        })();

        function startSync() {
            onSnapshot(getCol('expenses'), (snap) => {
                window.state.expenses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('loader').style.display = 'none';
                refreshUI();
            });

            onSnapshot(getCol('debts'), (snap) => {
                window.state.debts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                refreshUI();
            });

            onSnapshot(doc(db, 'artifacts', appIdStr, 'public', 'data', 'config', 'settings'), (snap) => {
                if(snap.exists()) {
                    window.state.categories = snap.data().categories || window.state.categories;
                    refreshUI();
                }
            });
        }

        window.dbActions = {
            addExp: async (d) => await setDoc(doc(getCol('expenses')), d),
            addDebt: async (d) => await setDoc(doc(getCol('debts')), d),
            markPaid: async (id) => await updateDoc(getDocRef('debts', id), { isPaid: true }),
            deleteItem: async (col, id) => await deleteDoc(getDocRef(col, id)),
            updateCats: async (c) => await setDoc(doc(db, 'artifacts', appIdStr, 'public', 'data', 'config', 'settings'), { categories: c }),
            bulkUpload: async (exps, dbts, cats) => {
                const batch = writeBatch(db);
                exps.forEach(e => batch.set(doc(getCol('expenses')), e));
                dbts.forEach(d => batch.set(doc(getCol('debts')), d));
                batch.set(doc(db, 'artifacts', appIdStr, 'public', 'data', 'config', 'settings'), { categories: cats });
                await batch.commit();
            },
            clearAll: async () => {
                const batch = writeBatch(db);
                window.state.expenses.forEach(e => batch.delete(getDocRef('expenses', e.id)));
                window.state.debts.forEach(d => batch.delete(getDocRef('debts', d.id)));
                await batch.commit();
            }
        };
    </script>

    <!-- UI Logic -->
    <script>
        const fmtRp = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
        const getShortDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }) : "-";

        function refreshUI() {
            renderDashboard(); renderExpensesTab(); renderPiutangTab();
            initFilters(); renderCategories(); updateCategorySelect();
            lucide.createIcons();
        }

        function renderDashboard() {
            const now = new Date(); const curM = now.toISOString().substring(0, 7); const curY = now.getFullYear().toString();
            const expM = window.state.expenses.filter(e => (e.date||"").startsWith(curM));
            const expY = window.state.expenses.filter(e => (e.date||"").startsWith(curY));
            const debtM = window.state.debts.filter(d => (d.date||"").startsWith(curM));
            const debtActive = window.state.debts.filter(d => !d.isPaid);

            document.getElementById('sum-exp-month-val').innerText = fmtRp(expM.reduce((a,b)=>a+Number(b.amount), 0));
            document.getElementById('sum-exp-month-count').innerText = `${expM.length} Transaksi`;
            document.getElementById('sum-exp-year-val').innerText = fmtRp(expY.reduce((a,b)=>a+Number(b.amount), 0));
            document.getElementById('sum-exp-year-count').innerText = `${expY.length} Transaksi`;

            document.getElementById('sum-debt-month-val').innerText = fmtRp(debtM.reduce((a,b)=>a+Number(b.amount), 0));
            document.getElementById('sum-debt-month-count').innerText = `${debtM.length} Piutang`;
            document.getElementById('sum-debt-total-val').innerText = fmtRp(debtActive.reduce((a,b)=>a+Number(b.amount), 0));
            document.getElementById('sum-debt-total-count').innerText = `${debtActive.length} Belum Lunas`;

            const list = document.getElementById('home-activity-list'); list.innerHTML = '';
            const combined = [...window.state.expenses.map(e=>({...e,t:'exp'})), ...window.state.debts.map(d=>({...d,t:'debt'}))]
                             .sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0, 8);
            if(combined.length === 0) list.innerHTML = `<p class="text-center py-6 text-slate-400 text-[10px] italic">Data cloud kosong.</p>`;
            combined.forEach(i => {
                const isE = i.t === 'exp';
                const div = document.createElement('div');
                div.className = "card-neo p-4 flex justify-between items-center";
                div.innerHTML = `<div class="flex items-center gap-3">
                    <div class="p-2.5 ${isE?'bg-teal-50 text-teal-600':'bg-indigo-50 text-indigo-600'} rounded-2xl shadow-sm"><i data-lucide="${isE?'shopping-bag':'hand-coins'}" class="w-4 h-4"></i></div>
                    <div><p class="text-[13px] font-bold text-slate-800 leading-tight truncate max-w-[130px]">${i.description||i.name}</p><p class="text-[9px] text-slate-400 font-black uppercase mt-0.5">${getShortDate(i.date)}</p></div>
                </div><p class="text-[13px] font-black ${isE?'text-teal-600':'text-indigo-600'}">${isE?'-':''}${fmtRp(i.amount)}</p>`;
                list.appendChild(div);
            });
        }

        function renderExpensesTab() {
            const m = document.getElementById('exp-filter-month').value;
            const y = document.getElementById('exp-filter-year').value;
            const container = document.getElementById('expense-list-full'); container.innerHTML = '';
            const filtered = window.state.expenses.filter(e => {
                const d = new Date(e.date);
                return (d.getMonth()+1).toString().padStart(2,'0') === m && d.getFullYear().toString() === y;
            }).sort((a,b)=>new Date(b.date)-new Date(a.date));

            document.getElementById('exp-filter-total').innerText = fmtRp(filtered.reduce((a,b)=>a+Number(b.amount),0));
            document.getElementById('exp-filter-count').innerText = `${filtered.length} Transaksi`;
            filtered.forEach(i => {
                const div = document.createElement('div');
                div.className = "card-neo p-4 flex justify-between items-center bg-white mb-2";
                div.innerHTML = `<div class="flex items-center gap-3"><div class="text-teal-600"><i data-lucide="tag" class="w-4 h-4"></i></div>
                    <div><p class="text-sm font-bold text-slate-800">${i.description}</p><p class="text-[9px] font-black text-teal-500 uppercase">${getShortDate(i.date)} â€¢ ${i.category}</p></div>
                    </div><div class="flex items-center gap-4"><p class="text-sm font-black text-slate-900">${fmtRp(i.amount)}</p>
                    <button onclick="window.dbActions.deleteItem('expenses','${i.id}')" class="text-slate-200 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
                container.appendChild(div);
            });
        }

        function renderPiutangTab() {
            const m = document.getElementById('debt-filter-month').value;
            const y = document.getElementById('debt-filter-year').value;
            const container = document.getElementById('debt-list-full'); container.innerHTML = '';
            const filtered = window.state.debts.filter(d => {
                const dateObj = new Date(d.date);
                return (dateObj.getMonth()+1).toString().padStart(2,'0') === m && dateObj.getFullYear().toString() === y;
            }).sort((a,b)=>new Date(b.date)-new Date(a.date));

            document.getElementById('debt-filter-total').innerText = fmtRp(filtered.reduce((a,b)=>a+Number(b.amount),0));
            document.getElementById('debt-filter-count').innerText = `${filtered.length} Item`;
            filtered.forEach(i => {
                const div = document.createElement('div');
                div.className = `card-neo p-5 mb-2 ${i.isPaid?'opacity-40 grayscale bg-slate-50 shadow-none':'border-indigo-100'}`;
                div.innerHTML = `<div class="flex justify-between items-start mb-4"><div><p class="text-[9px] font-black text-indigo-600 uppercase tracking-widest">${getShortDate(i.date)}</p>
                    <p class="text-base font-black text-slate-900">${i.name}</p></div><p class="text-base font-black text-indigo-600">${fmtRp(i.amount)}</p></div>
                    <div class="flex gap-2">${!i.isPaid?`<button onclick="window.dbActions.markPaid('${i.id}')" class="flex-1 bg-indigo-600 text-white text-[10px] py-3 rounded-xl font-black uppercase tracking-wider">Lunas</button>`:''}
                    <button onclick="window.dbActions.deleteItem('debts','${i.id}')" class="p-3 bg-rose-50 text-rose-500 rounded-xl hover:bg-rose-100 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
                container.appendChild(div);
            });
        }

        function renderCategories() {
            const list = document.getElementById('cat-manager-list'); if(!list) return;
            list.innerHTML = '';
            window.state.categories.forEach((c,i) => {
                const d = document.createElement('div');
                d.className = "flex justify-between items-center p-3 bg-white border border-slate-100 rounded-2xl shadow-sm";
                d.innerHTML = `<span class="text-xs font-bold text-slate-700 truncate mr-2">${c}</span>
                               <button onclick="removeCat(${i})" class="text-slate-300 hover:text-rose-500"><i data-lucide="x" class="w-4 h-4"></i></button>`;
                list.appendChild(d);
            });
        }

        window.removeCat = async (i) => {
            const n = [...window.state.categories]; n.splice(i,1);
            await window.dbActions.updateCats(n);
        }

        document.getElementById('cat-form').onsubmit = async (e) => {
            e.preventDefault(); const v = document.getElementById('cat-new-name').value.trim();
            if(v && !window.state.categories.includes(v)){
                await window.dbActions.updateCats([...window.state.categories, v]);
                document.getElementById('cat-new-name').value = '';
                showToast("Kategori baru!");
            }
        };

        document.getElementById('expense-form').onsubmit = async (e) => {
            e.preventDefault();
            await window.dbActions.addExp({
                description: document.getElementById('exp-desc').value,
                amount: Number(document.getElementById('exp-amount').value),
                category: document.getElementById('exp-category').value,
                date: document.getElementById('exp-date').value
            });
            e.target.reset(); document.getElementById('exp-date').value = new Date().toISOString().split('T')[0];
            toggleForm('form-expense'); showToast("Simpan berhasil!");
        };

        document.getElementById('debt-form').onsubmit = async (e) => {
            e.preventDefault();
            await window.dbActions.addDebt({
                name: document.getElementById('debt-name').value,
                amount: Number(document.getElementById('debt-amount').value),
                date: document.getElementById('debt-date').value,
                isPaid: false
            });
            e.target.reset(); document.getElementById('debt-date').value = new Date().toISOString().split('T')[0];
            toggleForm('form-debt'); showToast("Piutang dicatat!");
        };

        window.toggleForm = (id) => document.getElementById(id).classList.toggle('hidden');
        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.replace('nav-active','text-slate-400'));
            const b = document.getElementById('btn-'+id); if(b) b.classList.replace('text-slate-400','nav-active');
            window.scrollTo(0,0);
        };

        function showToast(m) {
            const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m;
            t.classList.replace('hidden','flex'); setTimeout(()=>t.classList.replace('flex','hidden'),2500);
        }

        function initFilters() {
            const n = new Date(); const curM = (n.getMonth()+1).toString().padStart(2,'0'); const curY = n.getFullYear().toString();
            ['exp-filter-month','debt-filter-month'].forEach(sid => {
                const el = document.getElementById(sid); if(el && el.options.length === 0) {
                    ["01","02","03","04","05","06","07","08","09","10","11","12"].forEach(m => {
                        const o = document.createElement('option'); o.value = m; o.innerText = new Date(2000, parseInt(m)-1).toLocaleDateString('id-ID',{month:'long'});
                        el.appendChild(o);
                    }); el.value = curM;
                }
            });
            ['exp-filter-year','debt-filter-year'].forEach(sid => {
                const el = document.getElementById(sid); if(el && el.options.length === 0) {
                    [2024,2025,2026,2027].forEach(y => {
                        const o = document.createElement('option'); o.value = y.toString(); o.innerText = y.toString(); el.appendChild(o);
                    }); el.value = curY;
                }
            });
        }

        function updateCategorySelect() {
            const sel = document.getElementById('exp-category'); if(!sel) return;
            const cur = sel.value; sel.innerHTML = '';
            window.state.categories.forEach(c => { const o = document.createElement('option'); o.value=c; o.innerText=c; sel.appendChild(o); });
            if(window.state.categories.includes(cur)) sel.value = cur;
        }

        document.getElementById('file-import').onchange = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    let exps = [], dbts = [], cats = window.state.categories;
                    if(data.expenses) exps = data.expenses.map(i => ({
                        description: i.name || "Migrasi", 
                        amount: Number(i.amount),
                        category: i.categoryName || i.name || "Lainnya",
                        date: (i.createdAt || "").split('T')[0] || new Date().toISOString().split('T')[0]
                    }));
                    if(data.debts) dbts = data.debts.map(i => ({
                        name: i.borrower || "Peminjam", 
                        amount: Number(i.amount),
                        date: (i.createdAt || "").split('T')[0] || new Date().toISOString().split('T')[0],
                        isPaid: i.isPaid || false
                    }));
                    if(data.categories) cats = [...new Set([...cats, ...data.categories.map(c => c.name)])];
                    showToast("Sedang sinkronisasi cloud...");
                    await window.dbActions.bulkUpload(exps, dbts, cats);
                    showToast("Impor Selesai!"); switchTab('tab-home');
                } catch(err) { alert("File JSON tidak sesuai!"); }
            };
            reader.readAsText(file);
        };

        window.exportData = () => {
            const b = new Blob([JSON.stringify({expenses:window.state.expenses, debts:window.state.debts, categories:window.state.categories})], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `CatatUang_Backup.json`; a.click();
        };

        window.clearAllDataCloud = async () => {
            if(confirm("PERINGATAN: Hapus permanen seluruh data di Cloud?")){
                await window.dbActions.clearAll();
                showToast("Direset");
            }
        };
    </script>
</body>
</html>
